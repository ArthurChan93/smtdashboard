import streamlit as st
import pandas as pd
import os

# Function to process the uploaded files
def process_files(south_file, east_file):
    # Read the sheets from the uploaded files
    south_df = pd.read_excel(south_file, sheet_name='Stock_list', usecols=['ETA_Month', 'Item', 'Customer Reserved', 'Machine_QTY', 'ETA HK'])
    stk_df = pd.read_excel(east_file, sheet_name='STK', usecols=['ETA ', 'MACHINE TYPE', 'QTY', 'Customer', 'Âà∞Ë¥ßÊÉÖÂÜµ'])
    ind_df = pd.read_excel(east_file, sheet_name='IND', usecols=['ETA ', 'MACHINE TYPE', 'QTY', 'Customer', 'ETA '])

    # Rename columns for consistency
    south_df.rename(columns={'ETA_Month': 'Status', 'Item': 'Model', 'Customer Reserved': 'Customer', 'Machine_QTY': 'QTY', 'ETA HK': 'Incoming'}, inplace=True)
    stk_df.rename(columns={'Âà∞Ë¥ßÊÉÖÂÜµ': 'Status', 'MACHINE TYPE': 'Model', 'ETA ': 'Incoming'}, inplace=True)
    ind_df.rename(columns={'ETA ': 'Incoming', 'MACHINE TYPE': 'Model'}, inplace=True)

    # Filter out rows with "Â∑≤ÂèëË¥ß"
    south_df = south_df[~south_df['Status'].str.contains('Â∑≤ÂèëË¥ß', na=False)]
    stk_df = stk_df[~stk_df['Status'].str.contains('Â∑≤ÂèëË¥ß', na=False)]

    # Combine the dataframes
    combined_df = pd.concat([south_df, stk_df, ind_df], ignore_index=True)

    # Standardize the 'Status' column
    combined_df['Status'] = combined_df['Status'].replace({'Â∑≤Âà∞Ë¥ß': 'STOCK', 'Â∑≤ÁªèÂà∞Ë¥ß': 'STOCK', 'Â∑≤ÂèëË¥ß': None})
    combined_df.dropna(subset=['Status'], inplace=True)

    # Standardize the 'Incoming' column
    combined_df['Incoming'] = combined_df['Incoming'].apply(
        lambda x: 'TBA' if 'TBA' in str(x) else 
                  pd.to_datetime(x, errors='coerce').strftime('%b-%y').upper() if pd.notnull(pd.to_datetime(x, errors='coerce')) else x
    )

    # Further classification of 'Status' based on 'Incoming' column
    def classify_status(row):
        if row['Status'] == 'STOCK':
            return 'STOCK'
        elif 'TBA' in str(row['Incoming']):
            return 'TBA'
        elif pd.notnull(row['Incoming']) and '-' in str(row['Incoming']):
            return f"{row['Incoming']} Incoming"
        return None

    combined_df['Status'] = combined_df.apply(classify_status, axis=1)
    combined_df.dropna(subset=['Status'], inplace=True)

    # Standardize the 'Model' column
    combined_df['Model'] = combined_df['Model'].replace({
        'YSi-V(DL)': 'YSi-V', 'YSi-V(SL)': 'YSi-V',
        'YSM20R-2': 'YSM20R', 'YSM20R(PV)-2': 'YSM20R',
        'YSM20R-1': 'YSM20R', 'YSM20R(SV)-2': 'YSM20R',
        'YSM20R(PV)-1': 'YSM20R', 'YSM10 96': 'YSM10'
    })

    # Remove rows with missing or invalid 'Model'
    combined_df.dropna(subset=['Model'], inplace=True)

    return combined_df

# Function to pivot the data into the desired format
def pivot_data(df):
    # Group by Status and Model, summing QTY
    grouped = df.groupby(['Status', 'Model']).agg({'QTY': 'sum'}).reset_index()

    # Pivot the data
    pivot = grouped.pivot(index='Status', columns='Model', values='QTY').fillna(0).astype(int)  # Fill NaN with 0, convert to int
    pivot['Subtotal'] = pivot.sum(axis=1)  # Add Subtotal column

    # Add Grand Total row
    grand_total = pd.DataFrame(pivot.sum(axis=0)).T
    grand_total['Status'] = 'Grand Total'
    pivot = pd.concat([pivot.reset_index(), grand_total], ignore_index=True)

    # Custom sort function for Status
    def sort_status(status):
        if status == 'STOCK':
            return (0, None)  # STOCK always first
        if status == 'Grand Total':
            return (float('inf'), None)  # Grand Total always last
        if status == 'TBA':
            return (2, None)  # TBA second to last
        if 'Incoming' in status or 'OUT' in status:
            parts = status.split(' ')[0]  # Extract MM-YY part
            date = pd.to_datetime(parts, format='%b-%y', errors='coerce')
            if pd.notnull(date):
                return (1, date)  # Sort by date
        return (3, None)  # Other statuses

    # Add a custom sort key and sort
    pivot['SortKey'] = pivot['Status'].apply(sort_status)
    pivot = pivot.sort_values(by='SortKey').drop(columns=['SortKey'])
    pivot.reset_index(drop=True, inplace=True)

    return pivot

# Function to style the dataframe
def style_dataframe(df):
    def highlight_cells(val):
        if 'Subtotal' in str(val):
            return 'background-color: yellow'  # Yellow background for Subtotal
        elif 'STOCK' in str(val):
            return 'background-color: lightgreen'  # Light green background for STOCK
        elif 'TBA' in str(val):
            return 'background-color: orange'  # Orange background for TBA        
        elif val == 'Subtotal' or val == 'Grand Total':
            return 'background-color: yellow'  # Yellow background for Subtotal and Grand Total
        elif 'Incoming' in str(val):
            return 'background-color: lightpink'  # Pink background for Incoming
        return ''
        
    # Apply highlight styling to all relevant columns
    styled_df = df.style.applymap(highlight_cells)  # Apply to all cells
    # Format numeric columns
    for col in df.columns[1:]:
        styled_df.format({col: '{:.0f}'})  # Remove decimal points for QTY
    return styled_df

# Streamlit app layout
st.title('üìäMachine Inventory and Incoming Status')

# Custom CSS for styling
st.markdown("""
    <style>
    .south-uploader {
        background-color: #FFE4B5;
        padding: 10px;
        border-radius: 5px;
    }
    .east-uploader {
        background-color: #ADD8E6;
        padding: 10px;
        border-radius: 5px;
    }
    .combine-button {
        color: red !important;
        border: 2px solid red !important;
        background: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .download-button {
        color: blue !important;
        border: 2px solid blue !important;
        background: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .report-title {
        font-size: 20px;
        font-weight: bold;
        text-decoration: underline;
    }
    </style>
    """, unsafe_allow_html=True)

# File uploaders with custom background colors
st.markdown('<div class="south-uploader">', unsafe_allow_html=True)
st.subheader(':orange[South]: STK info')
south_file = st.file_uploader('1Ô∏è‚É£ Upload :red[South stock information file]::point_down:', type='xlsx', key='south')
st.markdown('</div>', unsafe_allow_html=True)

st.markdown('<div class="east-uploader">', unsafe_allow_html=True)
st.subheader(':blue[EAST & WEST & NORTH]: STK info')
east_file = st.file_uploader('2Ô∏è‚É£ Upload :red[SHA stock information file]::point_down:', type='xlsx', key='east')
st.markdown('</div>', unsafe_allow_html=True)

# Combine button
left_column, right_column = st.columns(2)
with left_column:
    if st.button('Combine', key='combine_button'):
        if south_file and east_file:
            combined_df = process_files(south_file, east_file)
            pivoted_df = pivot_data(combined_df)

            # Display the summary report (renamed)
            st.markdown('<div class="report-title">STK Summary_[All Region]</div>', unsafe_allow_html=True)
            st.markdown(style_dataframe(pivoted_df).to_html(index=False), unsafe_allow_html=True)
            st.download_button('Download STK Summary Report_All Region', pivoted_df.to_csv(index=False), file_name='STK_summary_report_all_region.csv', 
                               key='download_all_region_button', help='Download the all region summary report')

            # Process South data separately
            south_df = pd.read_excel(south_file, sheet_name='Stock_list', usecols=['ETA_Month', 'Item', 'Customer Reserved', 'Machine_QTY', 'ETA HK'])
            south_df.rename(columns={'ETA_Month': 'Status', 'Item': 'Model', 'Customer Reserved': 'Customer', 'Machine_QTY': 'QTY', 'ETA HK': 'Incoming'}, inplace=True)
            south_df = south_df[~south_df['Status'].str.contains('Â∑≤ÂèëË¥ß', na=False)]
            south_df['Status'] = south_df['Status'].replace({'Â∑≤Âà∞Ë¥ß': 'STOCK', 'Â∑≤ÁªèÂà∞Ë¥ß': 'STOCK', 'Â∑≤ÂèëË¥ß': None})
            south_df.dropna(subset=['Status'], inplace=True)
            south_df['Incoming'] = south_df['Incoming'].apply(
                lambda x: 'TBA' if 'TBA' in str(x) else 
                          pd.to_datetime(x, errors='coerce').strftime('%b-%y').upper() if pd.notnull(pd.to_datetime(x, errors='coerce')) else x
            )
            south_df['Status'] = south_df.apply(lambda row: 'STOCK' if row['Status'] == 'STOCK' else 'TBA' if 'TBA' in str(row['Incoming']) else f"{row['Incoming']} Incoming" if pd.notnull(row['Incoming']) and '-' in str(row['Incoming']) else None, axis=1)
            south_df.dropna(subset=['Status'], inplace=True)
            south_df['Model'] = south_df['Model'].replace({
                'YSi-V(DL)': 'YSi-V', 'YSi-V(SL)': 'YSi-V',
                'YSM20R-2': 'YSM20R', 'YSM20R(PV)-2': 'YSM20R',
                'YSM20R-1': 'YSM20R', 'YSM20R(SV)-2': 'YSM20R',
                'YSM20R(PV)-1': 'YSM20R', 'YSM10 96': 'YSM10'
            })
            south_df.dropna(subset=['Model'], inplace=True)
            south_pivoted_df = pivot_data(south_df)

            # Display South summary report
            st.markdown('<div class="report-title">STK Summary_[SOUTH]</div>', unsafe_allow_html=True)
            st.markdown(style_dataframe(south_pivoted_df).to_html(index=False), unsafe_allow_html=True)
            st.download_button('Download STK Summary Report_SOUTH', south_pivoted_df.to_csv(index=False), file_name='STK_summary_report_south.csv', 
                               key='download_south_button', help='Download the South summary report')

            # Process East, West, and North data separately
            stk_df = pd.read_excel(east_file, sheet_name='STK', usecols=['ETA ', 'MACHINE TYPE', 'QTY', 'Customer', 'Âà∞Ë¥ßÊÉÖÂÜµ'])
            ind_df = pd.read_excel(east_file, sheet_name='IND', usecols=['ETA ', 'MACHINE TYPE', 'QTY', 'Customer', 'ETA '])
            stk_df.rename(columns={'Âà∞Ë¥ßÊÉÖÂÜµ': 'Status', 'MACHINE TYPE': 'Model', 'ETA ': 'Incoming'}, inplace=True)
            ind_df.rename(columns={'ETA ': 'Incoming', 'MACHINE TYPE': 'Model'}, inplace=True)
            stk_df = stk_df[~stk_df['Status'].str.contains('Â∑≤ÂèëË¥ß', na=False)]
            east_west_north_df = pd.concat([stk_df, ind_df], ignore_index=True)
            east_west_north_df['Status'] = east_west_north_df['Status'].replace({'Â∑≤Âà∞Ë¥ß': 'STOCK', 'Â∑≤ÁªèÂà∞Ë¥ß': 'STOCK', 'Â∑≤ÂèëË¥ß': None})
            east_west_north_df.dropna(subset=['Status'], inplace=True)
            east_west_north_df['Incoming'] = east_west_north_df['Incoming'].apply(
                lambda x: 'TBA' if 'TBA' in str(x) else 
                          pd.to_datetime(x, errors='coerce').strftime('%b-%y').upper() if pd.notnull(pd.to_datetime(x, errors='coerce')) else x
            )
            east_west_north_df['Status'] = east_west_north_df.apply(lambda row: 'STOCK' if row['Status'] == 'STOCK' else 'TBA' if 'TBA' in str(row['Incoming']) else f"{row['Incoming']} Incoming" if pd.notnull(row['Incoming']) and '-' in str(row['Incoming']) else None, axis=1)
            east_west_north_df.dropna(subset=['Status'], inplace=True)
            east_west_north_df['Model'] = east_west_north_df['Model'].replace({
                'YSi-V(DL)': 'YSi-V', 'YSi-V(SL)': 'YSi-V',
                'YSM20R-2': 'YSM20R', 'YSM20R(PV)-2': 'YSM20R',
                'YSM20R-1': 'YSM20R', 'YSM20R(SV)-2': 'YSM20R',
                'YSM20R(PV)-1': 'YSM20R', 'YSM10 96': 'YSM10'
            })
            east_west_north_df.dropna(subset=['Model'], inplace=True)
            east_west_north_pivoted_df = pivot_data(east_west_north_df)

            # Display East, West, and North summary report
            st.markdown('<div class="report-title">STK Summary_[EAST & WEST & NORTH] </div>', unsafe_allow_html=True)
            st.markdown(style_dataframe(east_west_north_pivoted_df).to_html(index=False), unsafe_allow_html=True)
            st.download_button('Download STK Summary Report_EAST & WEST & NORTH', east_west_north_pivoted_df.to_csv(index=False), file_name='STK_summary_report_east_west_north.csv', 
                               key='download_STK_east_west_north_button', help='Download the East, West, and North summary report')

        else:
            st.warning('Please upload both files to proceed.')


with right_column:
    # Ê∑ªÂä†Êñá‰ª∂‰∏äÂÇ≥Âô®
    monthly_report_file = st.file_uploader('3Ô∏è‚É£ Upload :red[Monthly Report_edit]: :point_down:', type=['xlsx', 'xlsm'], key='monthly_report')
    if monthly_report_file:
        # Áï∂Êñá‰ª∂Â∑≤ÊàêÂäü‰∏äÂÇ≥ÂæåÔºåÈáçÊñ∞Âü∑Ë°å‚ÄúCombine‚ÄùÂäüËÉΩ
        if south_file and east_file:
            combined_df = process_files(south_file, east_file)
            pivoted_df = pivot_data(combined_df)
            
            # ÂâµÂª∫Êñ∞Ë°®Ê†ºÔºåÂà™Èô§ `Status` Âàó‰∏≠ÂåÖÂê´ `TBA` ÁöÑË°å‰∏¶Â≠òÂÑ≤
            tba_row = pivoted_df[pivoted_df['Status'] == 'TBA'].copy()
            modified_pivoted_df = pivoted_df[pivoted_df['Status'] != 'TBA'].copy()
            
            # Èö±Ëóè Subtotal Âàó
            if 'Subtotal' in modified_pivoted_df.columns:
                modified_pivoted_df.drop(columns=['Subtotal'], inplace=True)
            
            # Âú®ÊØèÂÄã `Incoming` ÁãÄÊÖã‰πã‰∏ãÊ∑ªÂä†‰∏ÄË°å `OUT`
            incoming_indices = modified_pivoted_df.index[modified_pivoted_df['Status'].str.contains('Incoming')].tolist()
            rows_to_insert = []
            for idx in incoming_indices:
                out_row = modified_pivoted_df.iloc[idx].copy()
                # ‰øÆÊîπ Status ÁÇ∫ "MMM-YY OUT"
                incoming_date = out_row['Status'].split(' ')[0]
                out_row['Status'] = f"{incoming_date} OUT"
                # ‰øÆÊîπÊï∏ÈáèÁÇ∫Ë≤†Êï∏
                for col in modified_pivoted_df.columns[1:]:
                    out_row[col] = -1 * out_row[col]
                rows_to_insert.append((idx + 1, out_row))
            
            # ÊèíÂÖ•Ë°å
            for idx, row in rows_to_insert[::-1]:  # ÂøÖÈ†àÂÄíÂ∫èÊèíÂÖ•ÔºåÂê¶ÂâáÁ¥¢ÂºïÊúÉÈåØ‰∫Ç
                modified_pivoted_df = pd.concat([modified_pivoted_df.iloc[:idx], row.to_frame().T, modified_pivoted_df.iloc[idx:]]).reset_index(drop=True)
            
            # Â¶ÇÊûú Monthly Report Êñá‰ª∂Ë¢´Êèê‰æõÔºåÈÄ≤‰∏ÄÊ≠•ËôïÁêÜ
            monthly_df = pd.read_excel(monthly_report_file, sheet_name='raw_sheet')
            
            # ÈÅçÊ≠∑ÊØèÂÄã `Incoming` ÁãÄÊÖãÔºåÊèêÂèñÂ∞çÊáâÊï∏Êìö‰∏¶Â°´ÂÖÖ `OUT` Ë°å
            for idx, row in modified_pivoted_df.iterrows():
                if 'Incoming' in row['Status']:
                    # ÊèêÂèñÂπ¥Êúà
                    incoming_date = row['Status'].split(' ')[0]
                    month_year = pd.to_datetime(incoming_date, format='%b-%y', errors='coerce')
                    if pd.notnull(month_year):
                        year = month_year.year
                        month = month_year.month
                        
                        # ÈÅéÊøæ `Monthly Report` Êï∏Êìö
                        filtered_df = monthly_df[
                            (monthly_df['Inv_Yr'] == year) &
                            (monthly_df['Inv_Month'] == month) &
                            (monthly_df['Ordered_Items'].isin(pivoted_df.columns[1:]))  # ÊéíÈô§Èùû Model Âàó
                        ]
                        # Ë®àÁÆóÊØèÂÄã Model ÁöÑÊï∏ÈáèÁ∏ΩÂíå
                        model_sums = filtered_df.groupby('Ordered_Items')['Item Qty'].sum()
                        # Â°´ÂÖÖ `OUT` Ë°å
                        for model, qty in model_sums.items():
                            modified_pivoted_df.loc[idx + 1, model] = -1 * qty  # +1 ÊòØÂ∞çÊáâ `OUT` Ë°åÔºå‰∏¶È°ØÁ§∫ÁÇ∫Ë≤†Êï∏
            
            # ÊâæÂá∫ÊôÇÈñìÊúÄÈù†ÂæåÁöÑ‰∏ÄË°å `OUT`
            out_rows = modified_pivoted_df[modified_pivoted_df['Status'].str.contains('OUT')]
            if not out_rows.empty:
                out_rows['Date'] = out_rows['Status'].apply(lambda x: pd.to_datetime(x.split(' ')[0], format='%b-%y'))
                latest_out_row = out_rows[out_rows['Date'] == out_rows['Date'].max()]
                latest_out_date = latest_out_row['Date'].values[0]
                next_month = pd.to_datetime(latest_out_date) + pd.DateOffset(months=1)
                next_month_str = next_month.strftime('%b-%y').upper()

                # Ê™¢Êü• monthly_report_file ‰∏≠ÊòØÂê¶ÊúâÈÄôÁµÑÂπ¥ÊúàÁµÑÂêà
                next_year = next_month.year
                next_month_num = next_month.month
                next_month_filtered_df = monthly_df[
                    (monthly_df['Inv_Yr'] == next_year) &
                    (monthly_df['Inv_Month'] == next_month_num) &
                    (monthly_df['Ordered_Items'].isin(pivoted_df.columns[1:]))
                ]
                if not next_month_filtered_df.empty:
                    next_month_model_sums = next_month_filtered_df.groupby('Ordered_Items')['Item Qty'].sum()
                    new_out_row = modified_pivoted_df.iloc[0].copy()
                    new_out_row['Status'] = f"{next_month_str} OUT"
                    for model, qty in next_month_model_sums.items():
                        new_out_row[model] = -1 * qty

                    # ÊâæÂà∞ TBA Ë°åÁöÑÁ¥¢Âºï
                    tba_index = modified_pivoted_df[modified_pivoted_df['Status'] == 'Grand Total'].index[0]
                    # ÊèíÂÖ•Êñ∞ÁöÑ OUT Ë°å
                    modified_pivoted_df = pd.concat([modified_pivoted_df.iloc[:tba_index], new_out_row.to_frame().T, modified_pivoted_df.iloc[tba_index:]]).reset_index(drop=True)

            # Â∞á NaN ÊõøÊèõÁÇ∫ 0ÔºåËΩâÊèõÁÇ∫Êï¥Êï∏
            modified_pivoted_df.fillna(0, inplace=True)
            for col in modified_pivoted_df.columns[1:]:
                modified_pivoted_df[col] = modified_pivoted_df[col].astype(int)
            
                        # ÁßªÈô§Â∑≤ÊúâÁöÑ Grand Total Ë°åÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            modified_pivoted_df = modified_pivoted_df[modified_pivoted_df['Status'] != 'Grand Total']
            
            # Ë®àÁÆóÊñ∞ÁöÑ Grand Total ÂàóÔºåÂåÖÊã¨ TBA Ë°åÁöÑÊï∏ÂÄº
            grand_total_row = modified_pivoted_df.iloc[:, 1:].sum(axis=0)
            if not tba_row.empty:
                grand_total_row += tba_row.iloc[:, 1:].sum(axis=0)
            grand_total_row = grand_total_row.round(0).astype(int)  # Á¢∫‰øùÁÑ°Â∞èÊï∏Èªû
            grand_total_row['Status'] = 'Grand Total'
            
            # Ê∑ªÂä†Êñ∞ÁöÑ Grand Total Ë°å
            modified_pivoted_df = pd.concat([modified_pivoted_df, grand_total_row.to_frame().T], ignore_index=True)
            # ÊÅ¢Âæ© TBA Ë°åÂà∞ÂÄíÊï∏Á¨¨‰∫åË°å
            modified_pivoted_df = pd.concat([modified_pivoted_df.iloc[:-1], tba_row, modified_pivoted_df.iloc[-1:].reset_index(drop=True)], ignore_index=True)
            
            # **Êñ∞Â¢ûÁöÑÂäüËÉΩÔºöÁîüÊàê "Balance" Ë°®Ê†º**
            out_statuses = modified_pivoted_df[modified_pivoted_df['Status'].str.contains('OUT')]['Status'].tolist()
            balance_dates = [status.replace(' OUT', ' Balance') for status in out_statuses]
            balance_df = pd.DataFrame(columns=modified_pivoted_df.columns)
            for date in balance_dates:
                balance_row = modified_pivoted_df.iloc[0].copy()
                balance_row['Status'] = date
                balance_df = pd.concat([balance_df, balance_row.to_frame().T], ignore_index=True)

            # ‰øÆÊ≠£Á¥ØÁ©çÁ∏ΩÂíåÈÇèËºØ
            for idx, row in balance_df.iterrows():
                # ÊâæÂà∞Â∞çÊáâÁöÑ "OUT" Ë°å
                status_balance = row['Status']
                out_status = status_balance.replace('Balance', 'OUT')

                # ÊâæÂà∞Â∞çÊáâË°åÁöÑÁ¥¢Âºï
                out_idx = modified_pivoted_df[modified_pivoted_df['Status'] == out_status].index[0]

                # Ë®àÁÆóÂæûÈ†≠Âà∞Áï∂ÂâçË°åÁöÑÂä†Á∏Ω
                cumulative_sums = modified_pivoted_df.iloc[:out_idx + 1, 1:].sum(axis=0)
                for col in balance_df.columns[1:]:
                    balance_df.loc[idx, col] = cumulative_sums[col]

            # Â°´ÂÖÖ NaN ÂÄº‰∏¶Á¢∫‰øùÊï∏ÊìöÁÇ∫Êï¥Êï∏
            balance_df.fillna(0, inplace=True)
            for col in balance_df.columns[1:]:
                balance_df[col] = balance_df[col].astype(int)

            # Ê∑ªÂä† TBA Ë°åÂà∞ Balance Â†±Âëä
            tba_balance_row = tba_row.copy()
            tba_balance_row['Status'] = 'TBA Balance'
            balance_df = pd.concat([balance_df, tba_balance_row], ignore_index=True)

            # **ÁÇ∫ Balance Ë°åÂíå TBA Balance Ë°å‰∏≠ Status Ê†ºÂ≠êË®≠ÁΩÆËÉåÊôØËâ≤**
            def style_dataframe_with_balance(df):
                def highlight_status(cell):
                    if isinstance(cell, str):
                        if 'Balance' in cell and 'TBA' not in cell:
                            return 'background-color: pink'
                        elif 'TBA Balance' in cell:
                            return 'background-color: orange'
                    return ''

                styled_df = df.style.applymap(highlight_status, subset=['Status'])
                return styled_df

            # **È°ØÁ§∫Á¨¨‰∏ÄÂÄãË°®Ê†º**
            st.markdown('<div class="report-title">STK_[All Region] & Monthly Report Summary</div>', unsafe_allow_html=True)
            st.markdown(style_dataframe(modified_pivoted_df).to_html(index=False), unsafe_allow_html=True)

            # **Êèê‰æõÂÖ©ÂÄãË°®Ê†ºÁöÑ‰∏ãËºâÈÅ∏È†Ö**
            st.download_button(
                'Download Modified Report',
                modified_pivoted_df.to_csv(index=False),
                file_name='modified_report.csv',
                key='download_modified_button',
                help='Download the modified report'
            )

            # **È°ØÁ§∫Êñ∞ÁîüÊàêÁöÑ "Balance" Ë°®Ê†º**
            st.markdown('<div class="report-title">STK Monthly Balance & TBA </div>', unsafe_allow_html=True)
            st.markdown(style_dataframe_with_balance(balance_df).to_html(index=False), unsafe_allow_html=True)

            st.download_button(
                'Download STK Monthly Balance Report',
                balance_df.to_csv(index=False),
                file_name='STK Monthly Balance_report.csv',
                key='download_balance_button',
                help='Download the balance report'
            )
        else:
            st.warning('Please upload both South and East stock information files and combine first.')
